
<!DOCTYPE html>
<html lang="null">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="MarsBlog">
    <title>Return to libc - MarsBlog</title>
    <meta name="author" content="Mars Huang">
    
    
    <meta name="description" content="###source code &amp;amp; binaryvulvul.clibc.so
###若發現程式開了 DEP, ASLR, 而且為 dynamic link library 的時候就可以考慮使用 return to libc (因為 shellcode 無法在 stack 段執行且 gadget 數量太少很難湊出可以執行 shell 的 rop chain)
###可以使用 ldd 指令查看">
<meta property="og:type" content="blog">
<meta property="og:title" content="Return to libc">
<meta property="og:url" content="/2016/01/09/Return-to-libc/index.html">
<meta property="og:site_name" content="MarsBlog">
<meta property="og:description" content="###source code &amp;amp; binaryvulvul.clibc.so
###若發現程式開了 DEP, ASLR, 而且為 dynamic link library 的時候就可以考慮使用 return to libc (因為 shellcode 無法在 stack 段執行且 gadget 數量太少很難湊出可以執行 shell 的 rop chain)
###可以使用 ldd 指令查看">
<meta property="og:image" content="https://googledrive.com/host/0BzGd3Qn1ZnTeb01McHZmeFRtWFE">
<meta property="og:image" content="https://googledrive.com/host/0BzGd3Qn1ZnTeRktpcTRCZzVNMUE">
<meta property="og:image" content="https://googledrive.com/host/0BzGd3Qn1ZnTeekhUbnR3X3AxN2s">
<meta property="og:image" content="https://googledrive.com/host/0BzGd3Qn1ZnTeOC1JVzFHTVVHdlU">
<meta property="og:image" content="https://googledrive.com/host/0BzGd3Qn1ZnTeQnlnZ01ET2NhdjQ">
<meta property="og:updated_time" content="2016-01-09T08:55:21.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Return to libc">
<meta name="twitter:description" content="###source code &amp;amp; binaryvulvul.clibc.so
###若發現程式開了 DEP, ASLR, 而且為 dynamic link library 的時候就可以考慮使用 return to libc (因為 shellcode 無法在 stack 段執行且 gadget 數量太少很難湊出可以執行 shell 的 rop chain)
###可以使用 ldd 指令查看">
    
    
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style.min.css" type="text/css">
    <!--STYLES END-->
    
</head>

    <body>
        <div id="blog">
            <header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">MarsBlog</a>
    </h1>
    
</header>
            <nav id="sidebar" data-behavior="4">
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">Início</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">Categorias</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">Tags</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">Arquivo</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link st-search-show-outputs"
                         href="/#search"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                    <span class="sidebar-button-desc">Pesquisar</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">Sobre</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            Return to libc
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" content="Sat Jan 09 2016 15:35:13 GMT+0800">
	
		    09/01/2016
    	
    </time>
    
</div>
</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <p>###source code &amp; binary<br><a href="https://drive.google.com/open?id=0BzGd3Qn1ZnTeNmU0WG9Qa0RpaGM" target="_blank" rel="external">vul</a><br><a href="https://drive.google.com/open?id=0BzGd3Qn1ZnTeZU1uUW9MbWJIVVE" target="_blank" rel="external">vul.c</a><br><a href="https://drive.google.com/open?id=0BzGd3Qn1ZnTeSkV3aUxxRzU5NDg" target="_blank" rel="external">libc.so</a></p>
<p>###若發現程式開了 DEP, ASLR, 而且為 dynamic link library 的時候就可以考慮使用 return to libc (因為 shellcode 無法在 stack 段執行且 gadget 數量太少很難湊出可以執行 shell 的 rop chain)</p>
<p>###可以使用 ldd 指令查看系統使用了哪些 library</p>
<p><img style="width: 700px;" src="https://googledrive.com/host/0BzGd3Qn1ZnTeb01McHZmeFRtWFE"></p>
<p>###readelf 指令可以查看 library function 資訊<br><img style="width: 700px;" src="https://googledrive.com/host/0BzGd3Qn1ZnTeRktpcTRCZzVNMUE"></p>
<p>###其中 system@GLIBC_2.0 為目標 function call，前面的記憶體位置只是 offset，並不是真正的位置，由於 ASLR 會讓函式每次載入的位置隨機變化，因此若要找到 shared library 在記憶體中的真正位置必須用下列方式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">real address = base address + offset</span><br></pre></td></tr></table></figure></p>
<p>###因此為了獲取 real address，必須 leak base address，這是 return to libc 中最重要的一步，leak address 可以透過 printf (format string)，read，write，puts (修改參數)的方式實踐，此程式則預設提供了搜尋記憶體位置的步驟，只要將任何一個程式使用到的 library function 的 got entry 位置的位址轉成 10 進位丟給程式即可獲得該位置在 runtime 的真實記憶體位置，此處以 puts 為例操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -d vul | less</span><br></pre></td></tr></table></figure></p>
<p><img style="width: 700px;" src="https://googledrive.com/host/0BzGd3Qn1ZnTeekhUbnR3X3AxN2s"></p>
<h3 id="u6B64_u8655_u7684_0x804a01c__u5373_u70BA_u525B_u624D_u63D0_u5230_u7684_got_entry_uFF0C_u518D_u900F_u904E_readelf__u7372_u5F97_puts__u7684_offset__28_u8981_u91DD_u5C0D_u984C_u76EE_u63D0_u4F9B_u7684_libc-so-6__u505A_u67E5_u8A62_uFF0C_u9019_u500B_libc__u610F_u6307_u5C6C_u65BC_u8A72_u7CFB_u7D71_u7684_library_29"><a href="#u6B64_u8655_u7684_0x804a01c__u5373_u70BA_u525B_u624D_u63D0_u5230_u7684_got_entry_uFF0C_u518D_u900F_u904E_readelf__u7372_u5F97_puts__u7684_offset__28_u8981_u91DD_u5C0D_u984C_u76EE_u63D0_u4F9B_u7684_libc-so-6__u505A_u67E5_u8A62_uFF0C_u9019_u500B_libc__u610F_u6307_u5C6C_u65BC_u8A72_u7CFB_u7D71_u7684_library_29" class="headerlink" title="此處的 0x804a01c 即為剛才提到的 got entry，再透過 readelf 獲得 puts 的 offset (要針對題目提供的 libc.so.6 做查詢，這個 libc 意指屬於該系統的 library)"></a>此處的 0x804a01c 即為剛才提到的 got entry，再透過 readelf 獲得 puts 的 offset (要針對題目提供的 libc.so.6 做查詢，這個 libc 意指屬於該系統的 library)</h3><p><img style="width: 700px;" src="https://googledrive.com/host/0BzGd3Qn1ZnTeOC1JVzFHTVVHdlU"></p>
<p>###此處的 puts@@GLIBC_2.0 前面的位址即為 puts function 的 offset，將剛剛獲得的 puts real address 減去 puts offset 就可以得到 library 的 base address，再將 base address 加上 system offset 即可得到 system function 的真實位置</p>
<p>###依舊透過 buffer overflow 覆蓋 return address 成剛剛找到的 system real address，不過值得注意的是 system 還需要 /bin/sh 字串來執行 shell，這個字串可以透過 hexeditor 在 libc file 中查找即可得到該字串的 offset，一樣加上 base address 之後就可以得到真實位置，值得注意的是這個參數的擺放位置，由於 stack frame 裡面的 layout 為下圖<br><img src="https://googledrive.com/host/0BzGd3Qn1ZnTeQnlnZ01ET2NhdjQ"></p>
<p>###圖片下方為 high memory address，ebp 上方為 return address 再來才是參數 (parameter)，因此最後的 payload 如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">padding +&#10;p32(system_address) +&#10;&#34;AAAA&#34; +&#10;p32(bin/sh_address)</span><br></pre></td></tr></table></figure></p>
<p>###<a href="https://drive.google.com/open?id=0BzGd3Qn1ZnTecXgzZmZHMzFTN2s" target="_blank" rel="external">payload.py</a></p>

            
                

            
        </div>
    </div>
    <div class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">ETIQUETADO em</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/ctf-pwn/">ctf pwn</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/01/09/bubble-sort/"  data-tooltip="bubble-sort">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">ANTERIOR</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2015/11/29/Wireshark-Package-Analysis/" data-tooltip="Wireshark Package Analysis">
                
                    <span class="hide-xs hide-sm text-small icon-mr">PRÓXIMO</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=/2016/01/09/Return-to-libc/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=/2016/01/09/Return-to-libc/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=/2016/01/09/Return-to-libc/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2016 Mars Huang. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/01/09/bubble-sort/"  data-tooltip="bubble-sort">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">ANTERIOR</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2015/11/29/Wireshark-Package-Analysis/" data-tooltip="Wireshark Package Analysis">
                
                    <span class="hide-xs hide-sm text-small icon-mr">PRÓXIMO</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=/2016/01/09/Return-to-libc/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=/2016/01/09/Return-to-libc/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=/2016/01/09/Return-to-libc/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="4">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=/2016/01/09/Return-to-libc/">
                <i class="fa fa-google-plus"></i><span class="">Share on Google Plus</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=/2016/01/09/Return-to-libc/">
                <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=/2016/01/09/Return-to-libc/">
                <i class="fa fa-twitter"></i><span>Share on Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        <div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <h4 id="about-card-name">Mars Huang</h4>
        
            <h5 id="about-card-bio"><p>author.bio</p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </h5>
        
        
    </div>
</div>

        <div id="cover" style="background-image:url('http://res.cloudinary.com/tranquilpeak-hexo-theme/image/upload/v1438975482/v1.3.0-cover.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/script.min.js" type="text/javascript"></script>
<!--SCRIPTS END-->



</html>
